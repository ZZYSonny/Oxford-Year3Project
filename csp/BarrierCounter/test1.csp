include "correct.csp"
include "../lib/lists.csp"

hide = True


TypeThreadIDPermutation=Permutation(TypeThreadID)
TypeReturns=Arrangement(N,{0..M-1})
channel Sync: TypeThreadIDPermutation. TypeReturns

Spec(i) = Sync?perm!nElemList(N,i) -> Spec((i+1)%M)

Lin(All,me)=
  Call!me ->
  Sync?perms?returns ->
  Return!me!nthList(findList(me,perms),returns) ->
  Lin(All,me)

LinEvents(All,me)=union({
  Call.me
},union({
  Return.me.i |
  i <- TypeSeqNumber
},{
  Sync.perms.returns |
  perms <- TypeThreadIDPermutation,
  returns <- TypeReturns
}))

Linearizers(All)= || me: All @ [LinEvents(All,me)]  Lin(All,me)

System1 = runWith(hide,
    repeat(sync(TA)) |||
    repeat(sync(TB))
)
Spec1 = (Linearizers({TA, TB}) [|{|Sync|}|] Spec(0)) \ {|Sync|}
assert Spec1 [T= System1
assert System1 [T= Spec1